<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <div th:replace="/fragments/header.html :: fragment-header"></div>
</head>

<body>

<!-- container S -->
<div class="container">
    <input type="hidden" id="tournamentSeq" name="tournamentSeq" th:value="${params.tournamentSeq}">
    <!-- content S -->
    <div>
        <div class="con_top">
            <ul>
                <li>대회 관리</li>
                <li>레지스트레이션 목록</li>
            </ul>
        </div>
        <p class="page_info">레지스트레이션 목록</p>

        <form id="schFrm">
            <div class="search_option">
                <button type="button" class="add_btn" th:onclick="javascript:fnRegModal()">등록</button>
                <button type="button" class="add_btn" id="printButton" style="display:none;">출력</button>

                <p style="font-size: x-large;color: darkblue;-webkit-user-modify: read-write-plaintext-only;" th:text="|   ${totalInfo.startDate}|"></p>
                <p style="font-size: x-large;color: darkblue;-webkit-user-modify: read-write-plaintext-only;" th:text="|   ${totalInfo.tournamentName}|"></p>

                <p style="font-size: x-large;color: crimson;-webkit-user-modify: read-write-plaintext-only;" th:text="|   KLPT : ${totalInfo != null ? totalInfo.totalKlptCnt : 0}|"></p>
                <p style="font-size: x-large;color: crimson;-webkit-user-modify: read-write-plaintext-only;" th:text="|   초대권 : ${totalInfo != null ? totalInfo.totalInviCnt : 0}|"></p>
                <p style="font-size: x-large;color: crimson;-webkit-user-modify: read-write-plaintext-only;" th:text="|   프리티켓 : ${totalInfo != null ? totalInfo.totalFreeCnt : 0}|"></p>
            </div>
        </form>

        <div class="list_box">
            <table class="list">
                <colgroup>
                </colgroup>
                <thead>
                <tr>
                    <th scope="col">Register No.</th>
                    <th scope="col">핸드폰 번호</th>
                    <th scope="col">닉네임</th>
                    <th scope="col">레지 시간</th>
                    <th scope="col">Entry</th>
                    <th scope="col">사용 티켓</th>
                    <th scope="col">출력</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="list:${tournamentRegList}">
                    <td th:text="${list.rnum}"></td>
                    <td th:text="${list.regPhoneNum}"></td>
                    <td th:text="${list.nickName}"></td>
                    <td th:text="${list.regDate}"></td>
                    <td th:text="${list.entryCount}"></td>
                    <td th:text="${list.infoDesc}"></td>
                    <td>
                        <button type="button" class="tb_btn blue" th:onclick="javascript:fnPrint([[${list.seq}]])">출력</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- content E -->

</div>
<!-- container E -->
</body>
<script th:src="@{/static/js/common.js}"></script>
<script th:inline="javascript">

    var selectTrSeq;

    $( function() {
        $("#gameSeq").change(function(){
            location.href = "/game/blind/list?gameSeq="+$(this).val();
        })
    });

    function fnSearch(){
        $("#schFrm").submit();
    }

    function fnModalClose(id){
        $("#"+id).hide();
    }

    function fnRegModal(){
        $.ajax({
            contentType: false,
            processData: false,
            type: "POST",
            url: "/user/userAuthAjax",
            success: function(response) {
                if(response.userInfo.agentGbn == "GAME" || response.userInfo.agentGbn == "A"){
                    var url = "/user/list/popup";
                    window.open(url, "userList", "width=1200,height=600,scrollbars=yes,resizable=yes");
                }else {
                    alert("등록 권한이 없습니다. 로그인 정보를 확인 하여 주십시오.");
                    return false;
                }
            },
            error: function(err) {
                console.error("등록 실패:", err);
            }
        });
    }

    function registration(phoneNum, ticket5, ticket2, ticket4, onlineChecked) {

        $("#loading_modal").show();

        var formData = new FormData();
        formData.append("tournamentSeq", $("#tournamentSeq").val());
        formData.append("phoneNum", phoneNum);
        formData.append("ticket5", ticket5);
        formData.append("ticket2", ticket2);
        formData.append("ticket4", ticket4);
        formData.append("onlineChecked", onlineChecked);

        $.ajax({
            contentType: false,
            processData: false,
            type: "POST",
            url: "/tournament/registrationAjax",
            data: formData,
            success: function(response) {
                alert(response.resultMsg);

                var seq = response.seq;
                if(seq == ""){
                    alert("프린트 할 상대가 없습니다.");
                }else {
                    fnPrint(seq);
                }

                location.reload();
            },
            error: function(err) {
                console.error("등록 실패:", err);
            }
        });
    }

    function fnPrint(seq){
        var formData = new FormData();

        formData.append("seq", seq);

        $.ajax({
            contentType:false,
            processData:false,
            type: "POST",
            url: "/tournament/buyin/print",
            data: formData,
            success: function(data) {
                console.log("ESC/POS 문자열:", data);
                doPrint(data.printData);
            },
            error: function(err) {
                console.error("ESC/POS 생성 실패:", err);
            }
        });
    }

    function doPrint(printDto) {
        directPrintText("\n\n\n");

        // 2. ESC/POS 명령 대신, SDK의 함수를 순차적으로 호출합니다.

        // 가운데 정렬 (alignment: 2 - center)
        // 참고: 구버전 SDK의 setAlignment 함수는 printText 안에서 매개변수로 처리됩니다.

        // ✅ 첫 번째 줄: * 토너먼트 타이틀 *
        // printText(text, horizontal_multiplier, vertical_multiplier, bold, invert, underline, fonttype, alignment)
        // 2배 크기 (2, 2), 볼드 (true), 가운데 정렬 (2)
        printText(
            "* " + printDto.title + " *\n",
            2,
            2,
            true,
            false,
            false,
            'A', // 폰트 A 타입
            2    // 가운데 정렬
        );

        // 구분선은 기본 크기로 인쇄 (기본 크기: 1, 1)
        printText("---------------------\n", 1, 1, false, false, false, 'A', 2);

        // ✅ 두 번째 줄: 대회 이름 (설정 유지)
        printText(
            printDto.tournamentName + "\n",
            2,
            2,
            true,
            false,
            false,
            'A',
            2
        );

        // 세 번째 줄 (기본 크기/굵기)
        printText(
            printDto.infoDesc + "\n\n",
            1, // 기본 크기
            1,
            false, // 볼드 해제
            false,
            false,
            'A',
            2 // 가운데 정렬
        );

        // 네 번째 줄부터 다시 크게 설정 (DoubleSizeOn)
        printText(
            printDto.nickName + "\n",
            2, // 2배 크기
            2,
            false,
            false,
            false,
            'A',
            2
        );

        var entryNm = "";
        if (printDto.entryCount === 1) {
            entryNm = "Entry";
        } else {
            entryNm = "RE Entry";
        }

        printText(
            printDto.entryCount + " / " + printDto.totalEntryCount + "\n",
            2, // 2배 크기
            2,
            false,
            false,
            false,
            'A',
            2
        );

         printText(
            entryNm + "\n\n",
            2, // 2배 크기
            2,
            false,
            false,
            false,
            'A',
            2
        );


        // 크기 다시 해제 및 굵기 해제 (기본 크기)
        // 마지막 줄 (기본 크기)
        printText(
            printDto.regDate + "\n",
            1, // 1배 크기
            1,
            false, // 볼드 해제
            false,
            false,
            'A',
            2
        );

        // 다시 크게 설정하여 구분선 출력
         printText(
            "---------------------\n",
            2, // 2배 크기
            2,
            false,
            false,
            false,
            'A',
            2
        );

        // 마지막 줄 바꿈 추가 (directPrintText는 줄 바꿈 기호를 인식합니다)
        directPrintText("\n\n\n\n\n\n");

        // 용지 절단 (Cut)
        // cutPaper(bFeedCut) 함수 호출. bFeedCut 매개변수는 용지를 먼저 피딩할지 여부 (true/false)
        cutPaper(true);

        // 3. 빌더 대신 getPosData() 함수로 JSON 문자열 가져오기
        // 이 함수가 제공해주신 bxlpos.js 파일에 정의되어 있습니다.
        var jsonCommand = getPosData(); // 정의된 함수 호출

        // 4. bxlcommon.js의 printByweb 함수로 인쇄 실행
        // "BIXOLON SRP-330II" 대신 Web Print Config 설정의 "논리 이름" (예: Printer1) 사용
        var printerName = "KLPrint";

        // 이 코드는 bxlcommon.js가 정상적으로 로드되었다는 전제하에 작동합니다.
        requestPrint(printerName, jsonCommand, function(response) {
            // requestPrint의 콜백 처리 로직
            if (response.indexOf("Cannot connect") > -1 || response.indexOf("No printers") > -1 || response.indexOf("Error") > -1) {
                // 오류 발생 시
                if (typeof onPrintError === 'function') {
                    onPrintError(response, response);
                }
            } else {
                // 성공 시
                if (typeof onPrintSuccess === 'function') {
                    onPrintSuccess(response);
                }
            }
        });
    }

    // 콜백 함수 정의 (성공/실패 시 호출)
    function onPrintSuccess(res) {
        console.log("Print Success:", res);
        // 인쇄 성공 시 사용자에게 알림
    }

    function onPrintError(res) {
        console.error("Print Error:", res);
        // 인쇄 실패 시 사용자에게 알림 (예: SDK가 실행 중인지 확인 요청)
    }

    function callFunction() {
        console.log('call function');
    }

</script>

</html>
