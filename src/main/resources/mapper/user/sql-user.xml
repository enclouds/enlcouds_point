<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enclouds.enpoint.user.mapper.UserMapper">

	<select id="selectUserInfo" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.UserDto">
		select agent_code
		, id
		, agent_name
		, memo
		, format(point, 0) as point
		, format(ticket, 0) as ticket
		, format(ticket2, 0) as ticket2
		, format(ticket3, 0) as ticket3
		, format(ticket4, 0) as ticket4
		, format(ticket5, 0) as ticket5
		, point as pointInt
		, agent_gbn
		, agent_up_code
		, password
		from p_agent pa
		where 1=1
		and login_yn = 'Y'
		and id = #{id}
	</select>

	<select id="selectCustomUserInfo" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.UserDto">
		select *
		from (
		select *
		, @vRank := @vRank + 1 AS rank
		, (select count(*) from p_user) as totalRankCnt
		from p_user pu, (select @vRank := 0) as r
		order by pu.rank_sum_point desc
		) as cnt
		where phone_num = #{phoneNum}
	</select>

	<select id="selectCustomUserListTotalCount" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="int">
		select count(*)
		from p_user pu
		left join p_agent pa on pa.agent_code = pu.agent_code
		where 1=1
		<if test="id != 'hunters'">
			and phone_num not in ('01099077879', '01022306360')
		</if>
		<if test="schCond1 == 'nick'">
			AND pu.nick_name like '%${schText}%'
		</if>
		<if test="schCond1 == 'phone'">
			AND pu.phone_num like '%${schText}%'
		</if>
		<if test="schCond2 != ''">
			AND pa.agent_code = #{schCond2}
		</if>
	</select>

	<select id="selectCustomUserList" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.UserDto">
		select phone_num
		, case when length(phone_num) = 10 then concat(concat(SUBSTR(phone_num, 1 ,3), '***'), SUBSTR(phone_num, 7 ,10))
		when length(phone_num) = 11 then concat(concat(SUBSTR(phone_num, 1 ,4), '***'), SUBSTR(phone_num, 8 ,11))
		when length(phone_num) = 12 then concat(concat(SUBSTR(phone_num, 1 ,4), '***'), SUBSTR(phone_num, 8 ,11))
		end as phone_num_masking
		, nick_name
		, user_gbn
		, format(pu.point, 0) as point
		, pu.point as org_point
		, format(pu.ticket, 0) as ticket
		, format(pu.ticket2, 0) as ticket2
		, format(pu.ticket3, 0) as ticket3
		, format(pu.ticket4, 0) as ticket4
		, format(pu.ticket5, 0) as ticket5
		, pu.ticket as org_ticket
		, pu.ticket2 as org_ticket2
		, pu.ticket3 as org_ticket3
		, pu.ticket4 as org_ticket4
		, pu.ticket5 as org_ticket5
		, date_format(pu.reg_date, '%Y-%m-%d') as regDate
		, pu.memo
		, date_format((select max(pp.reg_date) from p_point pp where pp.phone_num = pu.phone_num), '%Y-%m-%d %H:%m:%s') as maxDate
		, rank_point
		, coupon_point as coupon_point
		, coupon_point as org_coupon_point
		, rank_sum_point
		, pu.agent_code
		, pa.agent_name
		from p_user pu
		left join p_agent pa on pa.agent_code = pu.agent_code
		where 1=1

		<if test="id != 'hunters'">
			and phone_num not in ('01099077879', '01022306360')
		</if>

		<if test="schCond1 == 'nick'">
			AND pu.nick_name like '%${schText}%'
		</if>
		<if test="schCond1 == 'phone'">
			AND pu.phone_num like '%${schText}%'
		</if>

		<if test="schCond2 != ''">
			AND pa.agent_code = #{schCond2}
		</if>

		order by pu.reg_date desc

		LIMIT
		#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
	</select>

	<select id="selectCustomUserListByVisit" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.UserDto">
		SELECT TAB.*
		FROM (
		SELECT pu.*
		, date_format((select max(pp.reg_date) from p_point pp where pp.phone_num = pu.phone_num), '%Y-%m-%d %H:%m:%s') as maxDate
		FROM p_user pu
		WHERE 1=1
			<if test="schCond2 != ''">
				AND pu.agent_code = #{schCond2}
			</if>
		) TAB
		WHERE TAB.maxDate is not null

		<if test="schStartDte != ''">
			<if test="schEndDte != ''">
				<![CDATA[
					and TAB.maxDate >= concat(#{schStartDte}, ' 00:00:00')
					and TAB.maxDate <= concat(#{schEndDte}, ' 23:59:59')
				]]>
			</if>
		</if>
		ORDER BY TAB.maxDate DESC

		LIMIT
		#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
	</select>

	<select id="selectCustomUserListByVisitTotalCount" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="int">
		SELECT count(*)
		FROM (
		SELECT pu.*
		, date_format((select max(pp.reg_date) from p_point pp where pp.phone_num = pu.phone_num), '%Y-%m-%d %H:%m:%s') as maxDate
		FROM p_user pu
		WHERE 1=1
		<if test="schCond2 != ''">
			AND pu.agent_code = #{schCond2}
		</if>
		) TAB
		WHERE TAB.maxDate is not null

		<if test="schStartDte != ''">
			<if test="schEndDte != ''">
				<![CDATA[
					and TAB.maxDate >= concat(#{schStartDte}, ' 00:00:00')
					and TAB.maxDate <= concat(#{schEndDte}, ' 23:59:59')
				]]>
			</if>
		</if>
	</select>

	<select id="selectDuplUser" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="int">
		select count(*)
		from p_user
		where 1=1
		and phone_num = #{phoneNum}
	</select>

	<insert id="insertUser" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_user
		( phone_num
		, nick_name
		, user_gbn
		, point
		, reg_date
		, memo
		, agent_code)
		VALUES
		( TRIM(#{phoneNum})
		, #{nickName}
		, 'NORMAL'
		, #{point}
		, NOW()
		, #{memo}
		, #{agentCode})
	</insert>

	<update id="updateUser" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET nick_name = #{nickName}
		, memo = #{memo}
		, agent_code = #{agentCode}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<delete id="deleteUser" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		DELETE FROM p_user
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</delete>

	<update id="updateUserAddPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET point = point + #{addPoint}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<insert id="insertAddPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_point
		( point_gbn
		, point
		, phone_num
		, agent_code
		, reg_date
		, def_point
		, private_def_point)
		VALUES
		( 'ADD'
		, #{addPoint}
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defPoint}
		, #{privateDefPoint})
	</insert>

	<insert id="insertAddTicket" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'ADD'
		, #{addTicket}
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertAddTicket2" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket2
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'ADD'
		, #{addTicket}
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertAddTicket3" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket3
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'ADD'
		, #{addTicket}
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertAddTicket4" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket4
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'ADD'
		, #{addTicket}
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertAddTicket5" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket5
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'ADD'
		, #{addTicket}
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<update id="updateUserMinusPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET point = point - #{minusPoint}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<insert id="insertMinusPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_point
		( point_gbn
		, point
		, phone_num
		, agent_code
		, reg_date
		, def_point
		, private_def_point)
		VALUES
		( 'MINUS'
		, #{minusPoint}
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defPoint}
		, #{privateDefPoint})
	</insert>

	<insert id="insertMinusTicket" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'MINUS'
		, -1
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertMinusTicketAsCnt" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'MINUS'
		, #{minusTicket} * -1
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertMinusTicketAsCnt2" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket2
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'MINUS'
		, #{minusTicket} * -1
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertMinusTicketAsCnt3" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket3
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'MINUS'
		, #{minusTicket} * -1
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertMinusTicketAsCnt4" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket4
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'MINUS'
		, #{minusTicket} * -1
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertMinusTicketAsCnt5" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket5
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'MINUS'
		, #{minusTicket} * -1
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertMinusTicket2" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket2
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'MINUS'
		, -1
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertMinusTicket3" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_ticket3
		( ticket_gbn
		, ticket
		, phone_num
		, agent_code
		, reg_date
		, def_ticket
		, private_def_ticket)
		VALUES
		( 'MINUS'
		, -1
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defTicket}
		, #{privateDefTicket})
	</insert>

	<insert id="insertHumanPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_point
		( point_gbn
		, point
		, phone_num
		, agent_code
		, reg_date
		, def_point
		, private_def_point)
		VALUES
		( 'HUMAN'
		, #{minusPoint}
		, #{phoneNum}
		, #{agentCode}
		, NOW()
		, #{defPoint}
		, #{privateDefPoint})
	</insert>

	<select id="selectPointHistory" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		SELECT seq
		, point_gbn
		, case when point_gbn = 'ADD' then '적립' when 'HUMAN' then '휴먼' else '차감' end as pointGbnNm
		, case when point_gbn = 'ADD' then format(pp.point, 0) else format(pp.point * -1, 0) end as point
		, date_format(pp.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		, phone_num
		, pp.agent_code
		, pa.agent_name
		, format(pp.private_def_point, 0) as privateDefPointStr
		FROM p_point pp
		left join p_agent pa on pp.agent_code = pa.agent_code
		WHERE 1=1
		AND phone_num = #{phoneNum}
		AND pp.reg_date BETWEEN DATE_ADD(NOW(), INTERVAL -3 MONTH) AND NOW()
		order by pp.reg_date desc
	</select>

	<select id="selectTicketHistory" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select case when ticket_gbn = 'ADD' then '적립' else '차감' end as ticketGbnNm
		, case when ticket_gbn = 'ADD' then format(pt.ticket, 0) else format(pt.ticket * -1, 0) end as ticket
		, pt.phone_num
		, pa.agent_name
		, date_format(pt.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		from p_ticket pt
		left join p_agent pa on pa.agent_code = pt.agent_code
		WHERE 1=1
		AND phone_num = #{phoneNum}
		AND pt.reg_date BETWEEN DATE_ADD(NOW(), INTERVAL -3 MONTH) AND NOW()
		order by pt.reg_date desc
	</select>

	<select id="selectTicketHistory2" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select case when ticket_gbn = 'ADD' then '적립' else '차감' end as ticketGbnNm
		, case when ticket_gbn = 'ADD' then format(pt.ticket, 0) else format(pt.ticket * -1, 0) end as ticket
		, pt.phone_num
		, pa.agent_name
		, date_format(pt.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		from p_ticket2 pt
		left join p_agent pa on pa.agent_code = pt.agent_code
		WHERE 1=1
		AND phone_num = #{phoneNum}
		AND pt.reg_date BETWEEN DATE_ADD(NOW(), INTERVAL -3 MONTH) AND NOW()
		order by pt.reg_date desc
	</select>

	<select id="selectTicketHistory3" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select case when ticket_gbn = 'ADD' then '적립' else '차감' end as ticketGbnNm
		, case when ticket_gbn = 'ADD' then format(pt.ticket, 0) else format(pt.ticket * -1, 0) end as ticket
		, pt.phone_num
		, pa.agent_name
		, date_format(pt.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		from p_ticket3 pt
		left join p_agent pa on pa.agent_code = pt.agent_code
		WHERE 1=1
		AND phone_num = #{phoneNum}
		AND pt.reg_date BETWEEN DATE_ADD(NOW(), INTERVAL -3 MONTH) AND NOW()
		order by pt.reg_date desc
	</select>

	<select id="selectTicketHistory4" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select case when ticket_gbn = 'ADD' then '적립' else '차감' end as ticketGbnNm
		, case when ticket_gbn = 'ADD' then format(pt.ticket, 0) else format(pt.ticket * -1, 0) end as ticket
		, pt.phone_num
		, pa.agent_name
		, date_format(pt.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		from p_ticket4 pt
		left join p_agent pa on pa.agent_code = pt.agent_code
		WHERE 1=1
		AND phone_num = #{phoneNum}
		AND pt.reg_date BETWEEN DATE_ADD(NOW(), INTERVAL -3 MONTH) AND NOW()
		order by pt.reg_date desc
	</select>

	<select id="selectTicketHistory5" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select case when ticket_gbn = 'ADD' then '적립' else '차감' end as ticketGbnNm
		, case when ticket_gbn = 'ADD' then format(pt.ticket, 0) else format(pt.ticket * -1, 0) end as ticket
		, pt.phone_num
		, pa.agent_name
		, date_format(pt.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		from p_ticket5 pt
		left join p_agent pa on pa.agent_code = pt.agent_code
		WHERE 1=1
		AND phone_num = #{phoneNum}
		AND pt.reg_date BETWEEN DATE_ADD(NOW(), INTERVAL -3 MONTH) AND NOW()
		order by pt.reg_date desc
	</select>

	<select id="getTotalCouponPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select format(coupon_point, 0) as point
		, coupon_point as couponPoint
		from p_user pu
		where 1=1
		and phone_num = #{phoneNum}
	</select>

	<select id="getTotalPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select format(point, 0) as point
		, point as pointInt
		, (select agent_name from p_agent pa where pa.agent_code = #{agentCode}) as agent_name
		, coupon_point as coupon_point
		, format(ticket, 0) as ticket1
		, format(ticket2, 0) as ticket2
		, format(ticket3, 0) as ticket3
		, format(ticket4, 0) as ticket4
		, format(ticket5, 0) as ticket5
		, nick_name
		, (select tel from p_agent pa where pa.agent_code = pu.agent_code) as agent_tel
		from p_user pu
		where 1=1
		and phone_num = #{phoneNum}
	</select>

	<select id="getTotalTicket" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select format(ticket, 0) as ticket
		, ticket as ticketInt
		, (select agent_name from p_agent pa where pa.agent_code = #{agentCode}) as agent_name
		from p_user pu
		where 1=1
		and phone_num = #{phoneNum}
	</select>

	<select id="getTotalTicket2" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select format(ticket2, 0) as ticket
		, ticket2 as ticketInt
		, (select agent_name from p_agent pa where pa.agent_code = #{agentCode}) as agent_name
		from p_user pu
		where 1=1
		and phone_num = #{phoneNum}
	</select>

	<select id="getTotalTicket3" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select format(ticket3, 0) as ticket
		, ticket3 as ticketInt
		, (select agent_name from p_agent pa where pa.agent_code = #{agentCode}) as agent_name
		from p_user pu
		where 1=1
		and phone_num = #{phoneNum}
	</select>

	<select id="getTotalTicket4" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select format(ticket4, 0) as ticket
		, ticket4 as ticketInt
		, (select agent_name from p_agent pa where pa.agent_code = #{agentCode}) as agent_name
		from p_user pu
		where 1=1
		and phone_num = #{phoneNum}
	</select>

	<select id="getTotalTicket5" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		select format(ticket5, 0) as ticket
		, ticket5 as ticketInt
		, (select agent_name from p_agent pa where pa.agent_code = #{agentCode}) as agent_name
		from p_user pu
		where 1=1
		and phone_num = #{phoneNum}
	</select>

	<select id="selectUserPointListTotalCount" parameterType="com.enclouds.enpoint.user.dto.PointDto" resultType="int">
		SELECT count(*)
		FROM p_point pp
		WHERE 1=1
		<choose>
			<when test='agentCode == 1'>
				<if test="schCond1 != ''">
					AND agent_code = #{schCond1}
				</if>
			</when>
			<otherwise>
				AND agent_code = #{agentCode}
			</otherwise>
		</choose>

		<choose>
			<when test="schCond2 == 'minus'">
				AND point_gbn = 'MINUS'
				AND pp.point = #{schText}
			</when>
			<when test="schCond2 == 'add'">
				AND point_gbn = 'ADD'
				AND pp.point = #{schText}
			</when>
		</choose>

		<![CDATA[
			and reg_date >= concat(#{schStartDte}, ' 16:00:00')
			and reg_date <= concat(date_add(#{schEndDte}, interval 1 day), ' 10:59:59')
		]]>
	</select>

	<select id="selectUserCouponListTotalCount" parameterType="com.enclouds.enpoint.user.dto.CouponDto" resultType="int">
		SELECT count(*)
		FROM p_coupon_history
		WHERE 1=1
		<choose>
			<when test='agentCode == 1'>
				<if test="schCond1 != ''">
					AND agent_code = #{schCond1}
				</if>
			</when>
			<otherwise>
				AND agent_code = #{agentCode}
			</otherwise>
		</choose>

		<choose>
			<when test="schCond2 == 'minus'">
				AND coupon_gbn = 'MINUS'
				AND coupon_cnt = #{schText}
			</when>
			<when test="schCond2 == 'add'">
				AND coupon_gbn = 'ADD'
				AND coupon_cnt = #{schText}
			</when>
		</choose>

		<![CDATA[
			and reg_date >= concat(#{schStartDte}, ' 16:00:00')
			and reg_date <= concat(date_add(#{schEndDte}, interval 1 day), ' 10:59:59')
		]]>
	</select>

	<select id="selectUserPointList" parameterType="com.enclouds.enpoint.user.dto.PointDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		SELECT pp.seq
		, pa.agent_name
		, pp.agent_code
		, case when point_gbn = 'ADD' then '적립' when 'HUMAN' then '휴먼' else '차감' end as pointGbnNm
		, case when point_gbn = 'ADD' then pp.point else 0 end as addPoint
		, case when point_gbn = 'MINUS' then pp.point * -1 else 0 end as minusPoint
		, date_format(pp.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		, pp.phone_num
		, case when length(pp.phone_num) = 10 then concat(concat(SUBSTR(pp.phone_num, 1 ,3), '***'), SUBSTR(pp.phone_num, 7 ,10))
		when length(pp.phone_num) = 11 then concat(concat(SUBSTR(pp.phone_num, 1 ,4), '***'), SUBSTR(pp.phone_num, 8 ,11))
		end as phone_num_masking
		, pu.nick_name
		, pp.def_point
		FROM p_point pp
		LEFT JOIN p_agent pa on pa.agent_code = pp.agent_code
		LEFT JOIN p_user pu on pu.phone_num = pp.phone_num
		WHERE 1=1

		<choose>
			<when test='agentCode == 1'>
				<if test="schCond1 != ''">
					AND pp.agent_code = #{schCond1}
				</if>
			</when>
			<otherwise>
				AND pp.agent_code = #{agentCode}
			</otherwise>
		</choose>

		<choose>
			<when test="schCond2 == 'minus'">
				AND point_gbn = 'MINUS'
				AND pp.point = #{schText}
			</when>
			<when test="schCond2 == 'add'">
				AND point_gbn = 'ADD'
				AND pp.point = #{schText}
			</when>
		</choose>

		<![CDATA[
			and pp.reg_date >= concat(#{schStartDte}, ' 16:00:00')
			and pp.reg_date <= concat(date_add(#{schEndDte}, interval 1 day), ' 15:59:59')
		]]>

		order by pp.reg_date desc

		LIMIT
		#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
	</select>

	<select id="selectUserCouponList" parameterType="com.enclouds.enpoint.user.dto.CouponDto" resultType="com.enclouds.enpoint.user.dto.CouponDto">
		select seq
		, pa.agent_name
		, pch .agent_code
		, case when coupon_gbn = 'ADD' then '적립' when 'HUMAN' then '휴먼' else '차감' end as couponGbnNm
		, case when coupon_gbn = 'ADD' then pch.coupon_cnt  else 0 end as addCoupon
		, case when coupon_gbn = 'MINUS' then pch.coupon_cnt * -1 else 0 end as minusCoupon
		, date_format(pch.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		, pch.phone_num
		, case when length(pch.phone_num ) = 10 then concat(concat(SUBSTR(pch.phone_num , 1 ,3), '***'), SUBSTR(pch.phone_num , 7 ,10))
		when length(pch.phone_num ) = 11 then concat(concat(SUBSTR(pch.phone_num , 1 ,4), '***'), SUBSTR(pch.phone_num , 8 ,11))
		end as phone_num_masking
		, pu.nick_name
		, pch.pre_coupon_cnt
		from p_coupon_history pch
		LEFT JOIN p_agent pa on pa.agent_code = pch.agent_code
		LEFT JOIN p_user pu on pu.phone_num = pch.phone_num
		where 1=1
		and pch.agent_code is not null
		and pch.agent_code != ''

		<choose>
			<when test='agentCode == 1'>
				<if test="schCond1 != ''">
					AND pch.agent_code = #{schCond1}
				</if>
			</when>
			<otherwise>
				AND pch.agent_code = #{agentCode}
			</otherwise>
		</choose>

		<choose>
			<when test="schCond2 == 'minus'">
				AND coupon_gbn = 'MINUS'
				AND pch.coupon_cnt = #{schText}
			</when>
			<when test="schCond2 == 'add'">
				AND coupon_gbn = 'ADD'
				AND pch.coupon_cnt = #{schText}
			</when>
		</choose>

		<![CDATA[
			and pch.reg_date >= concat(#{schStartDte}, ' 16:00:00')
			and pch.reg_date <= concat(date_add(#{schEndDte}, interval 1 day), ' 15:59:59')
		]]>

		order by pch.reg_date desc

		LIMIT
		#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
	</select>

	<select id="selectUserPointTotal" parameterType="com.enclouds.enpoint.user.dto.PointDto" resultType="com.enclouds.enpoint.user.dto.PointDto">
		SELECT ifnull(sum(case when point_gbn = 'ADD' then pp.point else 0 end), 0) as totalAddPoint
		, ifnull(sum(case when point_gbn = 'MINUS' then pp.point else 0 end) * -1, 0) as totalMinusPoint
		FROM p_point pp
		WHERE 1=1
		<choose>
			<when test='agentCode == 1'>
				<if test="schCond1 != ''">
					AND pp.agent_code = #{schCond1}
				</if>
			</when>
			<otherwise>
				AND pp.agent_code = #{agentCode}
			</otherwise>
		</choose>

		<choose>
			<when test="schCond2 == 'minus'">
				AND point_gbn = 'MINUS'
				AND pp.point = #{schText}
			</when>
			<when test="schCond2 == 'add'">
				AND point_gbn = 'ADD'
				AND pp.point = #{schText}
			</when>
		</choose>

		<![CDATA[
			and reg_date >= concat(#{schDate}, ' 16:00:00')
			and reg_date <= concat(date_add(#{schDate}, interval 1 day), ' 15:59:59')
		]]>
	</select>

	<select id="selectUserCouponTotal" parameterType="com.enclouds.enpoint.user.dto.CouponDto" resultType="com.enclouds.enpoint.user.dto.CouponDto">
		SELECT ifnull(sum(case when coupon_gbn = 'ADD' then coupon_cnt else 0 end), 0) as totalAddCoupon
		, ifnull(sum(case when coupon_gbn = 'MINUS' then coupon_cnt else 0 end) * -1, 0) as totalMinusCoupon
		FROM p_coupon_history
		WHERE 1=1
		<choose>
			<when test='agentCode == 1'>
				<if test="schCond1 != ''">
					AND agent_code = #{schCond1}
				</if>
			</when>
			<otherwise>
				AND agent_code = #{agentCode}
			</otherwise>
		</choose>

		<choose>
			<when test="schCond2 == 'minus'">
				AND coupon_gbn = 'MINUS'
				AND coupon_cnt = #{schText}
			</when>
			<when test="schCond2 == 'add'">
				AND coupon_gbn = 'ADD'
				AND coupon_cnt = #{schText}
			</when>
		</choose>

		<![CDATA[
			and reg_date >= concat(#{schDate}, ' 16:00:00')
			and reg_date <= concat(date_add(#{schDate}, interval 1 day), ' 15:59:59')
		]]>
	</select>

	<update id="updateUserAddRankPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET rank_point = rank_point + #{addRankPoint}
		, rank_sum_point = rank_sum_point + #{addRankPoint}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="updateUserMinusRankPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET rank_point = rank_point - #{minusRankPoint}
		, rank_sum_point = rank_sum_point - #{minusRankPoint}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="updateUserRankDef" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET rank_point = 0
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<select id="selectUserRankListListTotalCount" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="int">
		SELECT count(*)
		from (
		SELECT nick_name
		, phone_num
		, case when length(phone_num) = 10 then concat(concat(SUBSTR(phone_num, 1 ,3), '***'), SUBSTR(phone_num, 7 ,10))
		when length(phone_num) = 11 then concat(concat(SUBSTR(phone_num, 1 ,4), '***'), SUBSTR(phone_num, 8 ,11))
		end as phone_num_masking
		, rank_point
		, format(rank_point, 0) as rank_point_str
		, rank_sum_point
		, format(rank_sum_point, 0) as rank_sum_point_str
		, date_format(reg_date, '%Y-%m-%d') as regDate
		, date_format((select max(reg_date) from p_point pp where pp.phone_num = pu.phone_num), '%Y-%m-%d') as maxDate
		, CAST(rank_point AS signed integer) as intRankPoint
		, CAST(rank_sum_point AS signed integer) as intRankSumPoint
		, pu.agent_code
		FROM p_user pu, (SELECT @rownum:=0) TMP
		WHERE 1=1
		AND (rank_point > 0 or rank_sum_point > 0)
		AND pu.nick_name like '%${schText}%'
		) TAB
		WHERE 1=1
		<if test="schCond2 != ''">
			AND TAB.agent_code = #{schCond2}
		</if>
		<if test="schCond1 == 'week'">
			ORDER BY TAB.intRankPoint desc
		</if>
		<if test="schCond1 == 'sum'">
			ORDER BY TAB.intRankSumPoint desc
		</if>
	</select>

	<select id="selectUserRankList" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.UserDto">
		select *
		from (
		SELECT @rownum:=@rownum+1 as ranking, TAB.*
		from (
		SELECT nick_name
		, phone_num
		, case when length(phone_num) = 10 then concat(concat(SUBSTR(phone_num, 1 ,3), '***'), SUBSTR(phone_num, 7 ,10))
		when length(phone_num) = 11 then concat(concat(SUBSTR(phone_num, 1 ,4), '***'), SUBSTR(phone_num, 8 ,11))
		end as phone_num_masking
		, rank_point
		, format(rank_point, 0) as rank_point_str
		, rank_sum_point
		, format(rank_sum_point, 0) as rank_sum_point_str
		, date_format(reg_date, '%Y-%m-%d') as regDate
		, date_format((select max(reg_date) from p_point pp where pp.phone_num = pu.phone_num), '%Y-%m-%d') as maxDate
		, CAST(rank_point AS signed integer) as intRankPoint
		, CAST(rank_sum_point AS signed integer) as intRankSumPoint
		, pu.agent_code
		FROM p_user pu, (SELECT @rownum:=0) TMP
		WHERE 1=1
		AND (rank_point > 0 or rank_sum_point > 0)
		AND pu.nick_name like '%${schText}%'
		) TAB
		WHERE 1=1
		<if test="schCond2 != ''">
			AND TAB.agent_code = #{schCond2}
		</if>
		<if test="schCond1 == 'week'">
			ORDER BY TAB.intRankPoint desc
		</if>
		<if test="schCond1 == 'sum'">
			ORDER BY TAB.intRankSumPoint desc
		</if>
		) TAB
		LIMIT
		#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
	</select>

	<update id="updateUserAddCouponPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET coupon_point = coupon_point + #{addCouponPoint}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<insert id="insertCouponHistory" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		INSERT INTO p_coupon_history
		( phone_num
		, coupon_gbn
		, coupon_cnt
		, reg_date
		, pre_coupon_cnt
		, agent_code)
		VALUES
		( #{phoneNum}
		, #{couponGbn}
		, #{historyCouponCnt}
		, NOW()
		, replace(#{totalCouponPoint}, ',', '')
		, #{agentCode})
	</insert>

	<select id="selectCouponHistory" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.CouponDto">
		SELECT pch.coupon_gbn
		, pch.coupon_cnt
		, pch.pre_coupon_cnt
		, date_format(pch.reg_date, '%Y-%m-%d %H:%i:%s') as regDate
		, ifnull(pa.agent_name, '') as agentName
		FROM p_coupon_history pch
		left join p_agent pa on pa.agent_code = pch.agent_code
		WHERE 1=1
		AND pch.phone_num = #{phoneNum}
		AND pch.reg_date BETWEEN DATE_ADD(NOW(), INTERVAL -3 MONTH) AND NOW()
		ORDER BY pch.reg_date DESC
	</select>

	<update id="updateUserMinusCouponPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET coupon_point = coupon_point - #{minusCouponPoint}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="updateWeekRankPoint">
		UPDATE p_user
		SET rank_sum_point = rank_sum_point + rank_point
		WHERE 1=1
	</update>

	<update id="updateRankPointToZero">
		UPDATE p_user
		SET rank_point = 0
		WHERE 1=1
	</update>

	<update id="updateAllUserRankDefAjax">
		UPDATE p_user
		SET rank_sum_point = 0
		WHERE 1=1
	</update>

	<update id="updateAllUserWeekRankDefAjax">
		UPDATE p_user
		SET rank_point = 0
		WHERE 1=1
	</update>

	<update id="updateAllUserWeekTicketDefAjax">
		UPDATE p_user
		SET ticket = 0
		WHERE 1=1
	</update>

	<update id="updateAllUserRankMove">
		update p_user pu
		set pu.rank_sum_point = pu.rank_sum_point + pu.rank_point
	</update>

	<update id="updateAllUserRankMoveDef">
		update p_user pu
		set pu.rank_point = 0
	</update>

	<update id="updateUserAddTicket" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket = ticket + #{addTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="updateUserAddTicket2" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket2 = ticket2 + #{addTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="updateUserAddTicket3" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket3 = ticket3 + #{addTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="updateUserAddTicket4" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket4 = ticket4 + #{addTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="updateUserAddTicket5" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket5 = ticket5 + #{addTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="useTicket" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket = ticket - 1
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="useTicketAsCnt" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket = ticket - #{minusTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="useTicketAsCnt2" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket2 = ticket2 - #{minusTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="useTicketAsCnt3" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket3 = ticket3 - #{minusTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="useTicketAsCnt4" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket4 = ticket4 - #{minusTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="useTicketAsCnt5" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket5 = ticket5 - #{minusTicket}
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="useTicket2" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket2 = ticket2 - 1
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<update id="useTicket3" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket3 = ticket3 - 1
		WHERE 1=1
		AND phone_num = #{phoneNum}
	</update>

	<select id="selectUserTicketRankListTotalCount" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="int">
		SELECT count(*)
		from (
		SELECT nick_name
		, phone_num
		, case when length(phone_num) = 10 then concat(concat(SUBSTR(phone_num, 1 ,3), '***'), SUBSTR(phone_num, 7 ,10))
		when length(phone_num) = 11 then concat(concat(SUBSTR(phone_num, 1 ,4), '***'), SUBSTR(phone_num, 8 ,11))
		end as phone_num_masking
		, date_format(reg_date, '%Y-%m-%d') as regDate
		, date_format((select max(reg_date) from p_point pp where pp.phone_num = pu.phone_num), '%Y-%m-%d') as maxDate
		, CAST(ticket AS signed integer) as intRankTicket
		, CAST(ticket2 AS signed integer) as intRankTicket2
		, CAST(ticket3 AS signed integer) as intRankTicket3
		, CAST(ticket4 AS signed integer) as intRankTicket4
		, CAST(ticket5 AS signed integer) as intRankTicket5
		, pu.ticket
		, pu.ticket2
		, pu.ticket3
		, pu.ticket4
		, pu.ticket5
		, format(ticket, 0) as ticket_str
		, format(ticket2, 0) as ticket_str2
		, format(ticket3, 0) as ticket_str3
		, format(ticket4, 0) as ticket_str4
		, format(ticket5, 0) as ticket_str5
		, pu.agent_code
		FROM p_user pu,  (SELECT @rownum:=0) TMP
		WHERE 1=1
		AND pu.nick_name like '%${schText}%'
		AND (pu.ticket > 0 or pu.ticket2 > 0 or pu.ticket3 > 0)
		ORDER BY ticket desc
		) TAB
		WHERE 1=1
		<if test="schCond2 != ''">
			AND TAB.agent_code = #{schCond2}
		</if>
		<if test="schCond1 == 'ticket1'">
			ORDER BY TAB.intRankTicket desc
		</if>
		<if test="schCond1 == 'ticket2'">
			ORDER BY TAB.intRankTicket2 desc
		</if>
		<if test="schCond1 == 'ticket3'">
			ORDER BY TAB.intRankTicket3 desc
		</if>
		<if test="schCond1 == 'ticket4'">
			ORDER BY TAB.intRankTicket4 desc
		</if>
		<if test="schCond1 == 'ticket5'">
			ORDER BY TAB.intRankTicket5 desc
		</if>
	</select>

	<select id="selectUserTicketRankList" parameterType="com.enclouds.enpoint.user.dto.UserDto" resultType="com.enclouds.enpoint.user.dto.UserDto">
		select *
		from (
		SELECT @rownum:=@rownum+1 as ranking, TAB.*
		from (
		SELECT nick_name
		, phone_num
		, case when length(phone_num) = 10 then concat(concat(SUBSTR(phone_num, 1 ,3), '***'), SUBSTR(phone_num, 7 ,10))
		when length(phone_num) = 11 then concat(concat(SUBSTR(phone_num, 1 ,4), '***'), SUBSTR(phone_num, 8 ,11))
		end as phone_num_masking
		, date_format(reg_date, '%Y-%m-%d') as regDate
		, date_format((select max(reg_date) from p_point pp where pp.phone_num = pu.phone_num), '%Y-%m-%d') as maxDate
		, CAST(ticket AS signed integer) as intRankTicket
		, CAST(ticket2 AS signed integer) as intRankTicket2
		, CAST(ticket3 AS signed integer) as intRankTicket3
		, CAST(ticket4 AS signed integer) as intRankTicket4
		, CAST(ticket5 AS signed integer) as intRankTicket5
		, pu.ticket
		, pu.ticket2
		, pu.ticket3
		, pu.ticket4
		, pu.ticket5
		, format(ticket, 0) as ticket_str
		, format(ticket2, 0) as ticket_str2
		, format(ticket3, 0) as ticket_str3
		, format(ticket4, 0) as ticket_str4
		, format(ticket5, 0) as ticket_str5
		, pu.agent_code
		FROM p_user pu,  (SELECT @rownum:=0) TMP
		WHERE 1=1
		AND pu.nick_name like '%${schText}%'
		AND (pu.ticket > 0 or pu.ticket2 > 0 or pu.ticket3 > 0)
		ORDER BY ticket desc
		) TAB
		WHERE 1=1
		<if test="schCond2 != ''">
			AND TAB.agent_code = #{schCond2}
		</if>
		<if test="schCond1 == 'ticket1'">
			ORDER BY TAB.intRankTicket desc
		</if>
		<if test="schCond1 == 'ticket2'">
			ORDER BY TAB.intRankTicket2 desc
		</if>
		<if test="schCond1 == 'ticket3'">
			ORDER BY TAB.intRankTicket3 desc
		</if>
		<if test="schCond1 == 'ticket4'">
			ORDER BY TAB.intRankTicket4 desc
		</if>
		<if test="schCond1 == 'ticket5'">
			ORDER BY TAB.intRankTicket5 desc
		</if>
		) TAB
		LIMIT
		#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
	</select>

	<update id="updateUserAddSumRankPoint" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET rank_sum_point = rank_sum_point + #{addRankSumPoint}
		WHERE phone_num = #{phoneNum}
	</update>

	<update id="updateUserMinusSumRank" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET rank_sum_point = rank_sum_point - #{minusRankSumPoint}
		WHERE phone_num = #{phoneNum}
	</update>

	<update id="updateTicket1ResetAjax" parameterType="com.enclouds.enpoint.user.dto.UserDto">
		UPDATE p_user
		SET ticket = 0
	</update>

</mapper>


